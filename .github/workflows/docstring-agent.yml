name: NumPy Docstring Maintenance Agent

on:
  pull_request:
    paths:
      - 'src/**/*.py'
  push:
    branches:
      - main
      - master
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  docstring-check:
    name: Check and Maintain NumPy Docstrings
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"
          
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'
          
      - name: Install dependencies
        run: |
          uv sync
          uv pip install pydocstyle interrogate darglint
          
      - name: Validate NumPy docstrings with pydocstyle
        id: pydocstyle
        continue-on-error: true
        run: |
          uv run pydocstyle \
            --convention=numpy \
            --add-ignore=D100,D104,D105 \
            --match='(?!test_).*\.py' \
            src/ > pydocstyle-report.txt 2>&1 || true
          cat pydocstyle-report.txt
          
      - name: Check docstring coverage with interrogate
        id: interrogate
        continue-on-error: true
        run: |
          uv run interrogate \
            --verbose \
            --fail-under=80 \
            --exclude tests \
            --ignore-init-method \
            --ignore-private \
            --style=numpy \
            src/ > interrogate-report.txt 2>&1 || true
          cat interrogate-report.txt
          
      - name: Validate docstring arguments with darglint
        id: darglint
        continue-on-error: true
        run: |
          uv run darglint \
            --docstring-style=numpy \
            --strictness=short \
            src/ > darglint-report.txt 2>&1 || true
          cat darglint-report.txt
            
      - name: Create issue for docstring improvements
        if: steps.pydocstyle.outcome == 'failure' || steps.interrogate.outcome == 'failure' || steps.darglint.outcome == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            const pydocstyle = fs.existsSync('pydocstyle-report.txt') 
              ? fs.readFileSync('pydocstyle-report.txt', 'utf8') 
              : 'No issues';
            const interrogate = fs.existsSync('interrogate-report.txt')
              ? fs.readFileSync('interrogate-report.txt', 'utf8')
              : 'No issues';
            const darglint = fs.existsSync('darglint-report.txt')
              ? fs.readFileSync('darglint-report.txt', 'utf8')
              : 'No issues';
            
            const issueBody = `## NumPy Docstring Maintenance Required

Per **AGENTS.md ¬ß4.1.1**: Public APIs must use NumPy style docstrings.

### ¬ß Validation Reports

#### pydocstyle (NumPy Convention)
\`\`\`
${pydocstyle.slice(0, 3000)}
\`\`\`

#### interrogate (Coverage)
\`\`\`
${interrogate.slice(0, 3000)}
\`\`\`

#### darglint (Argument Validation)
\`\`\`
${darglint.slice(0, 3000)}
\`\`\`

### ¬ß Required Actions

0. Review files in \`src/\` with missing/incorrect docstrings
1. Add NumPy-style docstrings to all public methods/classes
2. Ensure Parameters, Returns, Raises sections are complete
3. Validate type hints match docstring types
4. Follow reference: \`src/numistalib/services/catalogues/service.py\`

### ¬ß Reference
- AGENTS.md ¬ß4.1 - Documentation standards
- Example: [catalogues/service.py](src/numistalib/services/catalogues/service.py)

**Triggered by**: ${context.eventName} on ${context.ref}
**Workflow run**: ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'üìù NumPy Docstring Maintenance Required',
              body: issueBody,
              labels: ['documentation', 'agent-task', 'docstrings']
            });
            
      - name: Comment on PR
        if: github.event_name == 'pull_request' && (steps.pydocstyle.outcome == 'failure' || steps.interrogate.outcome == 'failure')
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const summary = fs.readFileSync('interrogate-report.txt', 'utf8');
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `## üìù NumPy Docstring Check

Per **AGENTS.md ¬ß4.1.1**, public APIs require NumPy-style docstrings.

<details>
<summary>Coverage Report</summary>

\`\`\`
${summary.slice(0, 4000)}
\`\`\`
</details>

Please review and add missing docstrings before merging.`
            });
            
  docstring-report:
    name: Generate Docstring Coverage Badge
    runs-on: ubuntu-latest
    needs: docstring-check
    if: always()
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Install uv
        uses: astral-sh/setup-uv@v4
        
      - name: Generate badge
        run: |
          uv sync
          uv pip install interrogate
          uv run interrogate \
            --generate-badge docs/docstring-coverage.svg \
            --badge-format svg \
            src/
            
      - name: Commit badge
        if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add docs/docstring-coverage.svg
          git diff --staged --quiet || git commit -m "docs: update docstring coverage badge [skip ci]"
          git push
